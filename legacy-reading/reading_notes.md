# Legacy Reading Notes

このメモは「読みにくい既存コードから、仕様をどう推測したか」を採用者に示すための記録です。

## 1. 仕様推測の手掛かり

1. **分岐条件の網羅**
   - `tp` が `A/B/C/その他` で計算式が変わる。
   - `R` が `1/2/99/その他` で最終出力が変わる。
2. **入力異常系の早期return**
   - `x1` または `x2` が `None` のとき `-1` を返す。
3. **副作用の観測**
   - 呼び出しごとに `RUN_COUNTER["total"]` が増える。
   - `AUDIT_TRAIL` に結果と入力種別が追記される。
4. **隠れたフラグ依存**
   - `BONUS_MODE=True` のとき計算中間値に +5。

## 2. 観測できた暗黙仕様（テストで固定済み）

- `tp="A"` は乗算、`"B"` は加算、`"C"` は絶対差、その他は減算。
- `R=1` で 1.10倍、`R=2` で 1.20倍、`R=99` は強制的に 0。
- 計算結果は `int()` で丸め（切り捨て方向）。
- 返り値だけでなく、ログ追記と実行回数増加も事実上の仕様。

## 3. リスク評価

- 返り値だけを見て改修すると、副作用仕様（監査ログ/回数）が壊れやすい。
- グローバル状態依存のため、テストの前後で状態初期化しないと不安定化する。
- `R=99` の特殊分岐は業務ルールの可能性が高く、削除すると事故リスクが高い。

## 4. 改修時の判断

- まずテストで「戻り値 + 副作用」を固定。
- 次に純粋関数へ分解しつつ、互換ラッパーで既存仕様を保持。
- 最後に命名改善と定数化を行い、レビューしやすい構造にする。
